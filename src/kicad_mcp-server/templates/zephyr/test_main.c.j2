/**
 * Zephyr RTOS Test Suite for {{ project_name }}
 * Generated from {{ schematic_path }}
 *
 * Connectivity and functional tests using Zephyr testing framework.
 */

#include <zephyr/kernel.h>
#include <zephyr/ztest.h>
#include <zephyr/device.h>
#include <zephyr/drivers/gpio.h>

{% if target_mcu %}
/* Device tree aliases for {{ target_mcu }} */
{% endif %}

/* GPIO device structure */
static const struct gpio_dt_spec test_pins[] = {
{% for pin in test_pins %}
    { DT_NODELABEL({{ pin.node_label }), {{ pin.pin }}, GPIO_ACTIVE_LOW },
{% endfor %}
};

/* Test configuration */
#define TEST_STACK_SIZE 1024
#define TEST_PRIORITY 5

/* Global test counters */
static int tests_passed = 0;
static int tests_failed = 0;

/**
 * Test suite setup
 */
static void test_suite_setup(void)
{
    printk("{{ project_name }} - Zephyr Test Suite\n");
    printk("========================================\n\n");

    /* Initialize GPIO pins */
    for (size_t i = 0; i < ARRAY_SIZE(test_pins); i++) {
        if (!device_is_ready(test_pins[i].port)) {
            printk("ERROR: GPIO port not ready\n");
            zassert_true(false, "GPIO initialization failed");
        }

        gpio_pin_configure_dt(&test_pins[i], GPIO_INPUT);
    }
}

/**
 * Test power supply presence
 */
ZTEST(schematic_tests, test_power_supply)
{
    /* Verify power rails are present */
    /* This would typically use ADC or power monitoring IC */

    printk("Testing power supply...\n");

    {% if target_mcu and "esp32" in target_mcu %}
    /* ESP32: Use internal ADC to check VCC */
    int adc_reading = 0;
    // adc_read(...);
    printk("ADC reading: %d\n", adc_reading);
    {% elif target_mcu and "stm32" in target_mcu %}
    /* STM32: Use internal reference */
    printk("Power check via VREFINT\n");
    {% endif %}

    zassert_true(true, "Power supply test passed");
    tests_passed++;
}

/**
 * Test GPIO connectivity
 */
ZTEST(schematic_tests, test_gpio_connectivity)
{
    printk("Testing GPIO connectivity...\n");

    /* Test each GPIO pin */
    for (size_t i = 0; i < ARRAY_SIZE(test_pins); i++) {
        int value = gpio_pin_get_dt(&test_pins[i]);

        printk("Pin %zu: %d\n", i, value);

        /* Basic sanity check - pin should be readable */
        zassert_true(value >= 0, "GPIO pin read failed");
    }

    tests_passed++;
}

{% if test_type == "functional" %}
/**
 * Test I2C bus functionality
 */
ZTEST(schematic_tests, test_i2c_functionality)
{
    printk("Testing I2C functionality...\n");

    /* Scan I2C bus for devices */
    /* Implementation depends on I2C configuration in devicetree */

    printk("I2C scan complete\n");
    zassert_true(true, "I2C test passed");
    tests_passed++;
}

/**
 * Test SPI functionality
 */
ZTEST(schematic_tests, test_spi_functionality)
{
    printk("Testing SPI functionality...\n");

    /* Basic SPI communication test */
    /* Implementation depends on SPI configuration */

    printk("SPI test complete\n");
    zassert_true(true, "SPI test passed");
    tests_passed++;
}
{% endif %}

{% if test_type == "production" %}
/**
 * Production test - all pins
 */
ZTEST(schematic_tests, test_all_pins)
{
    printk("Testing all schematic pins...\n");

    /* Comprehensive pin test */
    int pin_count = ARRAY_SIZE(test_pins);

    printk("Total pins to test: %d\n", pin_count);

    for (size_t i = 0; i < ARRAY_SIZE(test_pins); i++) {
        /* Configure as output, set high, check with external tester */
        gpio_pin_configure_dt(&test_pins[i], GPIO_OUTPUT_ACTIVE);
        k_sleep(K_MSEC(10));

        /* Configure as input */
        gpio_pin_configure_dt(&test_pins[i], GPIO_INPUT);
        int value = gpio_pin_get_dt(&test_pins[i]);

        printk("Pin %zu: %d\n", i, value);
    }

    zassert_true(true, "Production pin test passed");
    tests_passed++;
}
{% endif %}

/**
 * Test suite teardown
 */
static void test_suite_teardown(void)
{
    printk("\n========================================\n");
    printk("Test Summary\n");
    printk("Passed: %d\n", tests_passed);
    printk("Failed: %d\n", tests_failed);
    printk("========================================\n");
}

/**
 * Test suite registration
 */
ZTEST_SUITE(schematic_tests,
            NULL,
            NULL,
            test_suite_setup,
            test_suite_teardown,
            NULL);

/**
 * Main entry point
 */
int main(void)
{
    ztest_run_test_suite(schematic_tests);
    return 0;
}
